<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src *; img-src 'self' data:;">
  <title>OPH-POS CAL Setup Wizard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
      color: #e2e8f0;
    }
    
    .wizard-container {
      max-width: 700px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #f8fafc;
    }
    
    .header p {
      color: #94a3b8;
      font-size: 14px;
    }
    
    .progress-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 40px;
    }
    
    .progress-step {
      width: 40px;
      height: 4px;
      background: #334155;
      border-radius: 2px;
      transition: background 0.3s;
    }
    
    .progress-step.active { background: #3b82f6; }
    .progress-step.completed { background: #22c55e; }
    
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 32px;
      border: 1px solid #334155;
    }
    
    .step { display: none; }
    .step.active { display: block; }
    
    .step-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #f8fafc;
    }
    
    .step-description {
      color: #94a3b8;
      margin-bottom: 24px;
      line-height: 1.5;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #cbd5e1;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 16px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f8fafc;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .form-group input::placeholder { color: #64748b; }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #0f172a;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #3b82f6;
    }
    
    .checkbox-group span { font-size: 14px; }
    
    .device-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .device-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #0f172a;
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .device-item:hover { border-color: #334155; }
    .device-item.selected { border-color: #3b82f6; background: #1e3a5f; }
    
    .device-item .icon {
      width: 40px;
      height: 40px;
      background: #334155;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .device-item .info h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .device-item .info span {
      font-size: 12px;
      color: #94a3b8;
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }
    
    .btn {
      flex: 1;
      padding: 14px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .btn-secondary {
      background: #334155;
      color: #f8fafc;
    }
    
    .btn-secondary:hover { background: #475569; }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover { background: #2563eb; }
    .btn-primary:disabled { background: #475569; cursor: not-allowed; opacity: 0.7; }
    
    .btn-success {
      background: #22c55e;
      color: white;
    }
    
    .btn-success:hover { background: #16a34a; }
    
    .install-log {
      background: #0f172a;
      border-radius: 8px;
      padding: 16px;
      max-height: 250px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.6;
    }
    
    .log-entry { margin-bottom: 4px; }
    .log-entry.info { color: #94a3b8; }
    .log-entry.success { color: #22c55e; }
    .log-entry.error { color: #ef4444; }
    .log-entry.warning { color: #f59e0b; }
    
    .install-progress {
      margin-bottom: 16px;
    }
    
    .install-progress .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    
    .install-progress .progress-track {
      height: 8px;
      background: #334155;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .install-progress .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      border-radius: 4px;
      transition: width 0.3s;
    }
    
    .summary-card {
      background: #0f172a;
      border-radius: 8px;
      padding: 20px;
    }
    
    .summary-card .row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #334155;
    }
    
    .summary-card .row:last-child { border-bottom: none; }
    .summary-card .label { color: #94a3b8; font-size: 14px; }
    .summary-card .value { color: #f8fafc; font-size: 14px; font-weight: 500; }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: #22c55e;
      border-radius: 50%;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }
    
    .system-info {
      background: #0f172a;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 13px;
    }
    
    .system-info .row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #1e293b;
    }
    
    .system-info .row:last-child { border-bottom: none; }
    
    .error-message {
      background: #7f1d1d;
      border: 1px solid #dc2626;
      color: #fecaca;
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
    }
    
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #475569;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="header">
      <h1>OPH-POS CAL Setup Wizard</h1>
      <p>Device Configuration and Installation</p>
      <p style="font-size: 12px; color: #64748b; margin-top: 8px;">Version 2.0.0</p>
    </div>
    
    <div class="progress-bar">
      <div class="progress-step active" id="prog-1"></div>
      <div class="progress-step" id="prog-2"></div>
      <div class="progress-step" id="prog-3"></div>
      <div class="progress-step" id="prog-4"></div>
      <div class="progress-step" id="prog-5"></div>
      <div class="progress-step" id="prog-6"></div>
    </div>
    
    <div class="card">
      <!-- Step 1: Cloud URL -->
      <div class="step active" id="step-1">
        <h2 class="step-title">Connect to Cloud</h2>
        <p class="step-description">Enter the URL of your OPH-POS cloud environment.</p>
        
        <div class="form-group">
          <label>Cloud URL</label>
          <input type="url" id="cloud-url" placeholder="https://your-environment.replit.app">
        </div>
        
        <div class="system-info" id="system-info">
          <div class="row">
            <span>Device Name</span>
            <span id="sys-hostname">Loading...</span>
          </div>
          <div class="row">
            <span>Platform</span>
            <span id="sys-platform">Loading...</span>
          </div>
          <div class="row">
            <span>Install Directory</span>
            <span id="sys-rootdir">Loading...</span>
          </div>
        </div>
        
        <div id="error-1" class="error-message" style="display: none;"></div>
        
        <div class="button-group">
          <button class="btn btn-primary" id="btn-connect">Connect</button>
        </div>
      </div>
      
      <!-- Step 2: EMC Login -->
      <div class="step" id="step-2">
        <h2 class="step-title">Administrator Login</h2>
        <p class="step-description">Sign in with your EMC administrator credentials.</p>
        
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="emc-email" placeholder="admin@company.com">
        </div>
        
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="emc-password" placeholder="Enter your password">
        </div>
        
        <div id="error-2" class="error-message" style="display: none;"></div>
        
        <div class="button-group">
          <button class="btn btn-secondary" id="btn-back-2">Back</button>
          <button class="btn btn-primary" id="btn-login">Sign In</button>
        </div>
      </div>
      
      <!-- Step 3: Select Property -->
      <div class="step" id="step-3">
        <h2 class="step-title">Select Property</h2>
        <p class="step-description">Choose the property this device will belong to.</p>
        
        <div class="device-list" id="property-list"></div>
        
        <div id="error-3" class="error-message" style="display: none;"></div>
        
        <div class="button-group">
          <button class="btn btn-secondary" id="btn-back-3">Back</button>
          <button class="btn btn-primary" id="btn-select-property" disabled>Continue</button>
        </div>
      </div>
      
      <!-- Step 4: Select Device -->
      <div class="step" id="step-4">
        <h2 class="step-title">Select Device</h2>
        <p class="step-description">Choose the workstation or KDS this device will be configured as.</p>
        
        <div class="device-list" id="device-list"></div>
        
        <div id="error-4" class="error-message" style="display: none;"></div>
        
        <div class="button-group">
          <button class="btn btn-secondary" id="btn-back-4">Back</button>
          <button class="btn btn-primary" id="btn-select-device" disabled>Continue</button>
        </div>
      </div>
      
      <!-- Step 5: Installation -->
      <div class="step" id="step-5">
        <h2 class="step-title">Installing</h2>
        <p class="step-description">Setting up OPH-POS on this device...</p>
        
        <div class="install-progress">
          <div class="progress-label">
            <span id="install-status">Preparing...</span>
            <span id="install-percent">0%</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" id="install-fill" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="install-log" id="install-log"></div>
        
        <div id="error-5" class="error-message" style="display: none;"></div>
        
        <div class="button-group" id="install-buttons" style="display: none;">
          <button class="btn btn-secondary" id="btn-retry">Retry</button>
        </div>
      </div>
      
      <!-- Step 6: Complete -->
      <div class="step" id="step-6">
        <div class="success-icon">‚úì</div>
        <h2 class="step-title" style="text-align: center;">Setup Complete!</h2>
        <p class="step-description" style="text-align: center;">This device is now configured and ready to use.</p>
        
        <div class="summary-card" id="summary-card"></div>
        
        <div class="button-group">
          <button class="btn btn-success" id="btn-launch">Launch POS</button>
          <button class="btn btn-secondary" id="btn-exit">Exit Wizard</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let currentStep = 1;
    let cloudUrl = '';
    let sessionToken = '';
    let selectedProperty = null;
    let selectedDevice = null;
    let registrationData = null;
    let systemInfo = null;
    let rootDir = '';
    let calClientInstalled = false;
    
    async function init() {
      systemInfo = await window.electronAPI.getSystemInfo();
      rootDir = systemInfo.defaultRootDir;
      
      document.getElementById('sys-hostname').textContent = systemInfo.hostname;
      document.getElementById('sys-platform').textContent = 
        systemInfo.platform === 'win32' ? 'Windows' : 
        systemInfo.platform === 'darwin' ? 'macOS' : 'Linux';
      document.getElementById('sys-rootdir').textContent = rootDir;
      
      window.electronAPI.onDownloadProgress((progress) => {
        updateProgress(progress, 'Downloading...');
      });
    }
    
    function showStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step-${step}`).classList.add('active');
      
      for (let i = 1; i <= 6; i++) {
        const prog = document.getElementById(`prog-${i}`);
        prog.classList.remove('active', 'completed');
        if (i < step) prog.classList.add('completed');
        if (i === step) prog.classList.add('active');
      }
      
      currentStep = step;
    }
    
    function showError(step, message) {
      const errorEl = document.getElementById(`error-${step}`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
      window.electronAPI.writeLog('ERROR', `Step ${step} error: ${message}`);
    }
    
    function hideError(step) {
      const errorEl = document.getElementById(`error-${step}`);
      if (errorEl) errorEl.style.display = 'none';
    }
    
    function log(message, type = 'info') {
      const logEl = document.getElementById('install-log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      
      const level = type === 'error' ? 'ERROR' : type === 'warning' ? 'WARN' : type === 'success' ? 'INFO' : 'INFO';
      window.electronAPI.writeLog(level, message);
    }
    
    function updateProgress(percent, status) {
      document.getElementById('install-fill').style.width = `${percent}%`;
      document.getElementById('install-percent').textContent = `${percent}%`;
      if (status) document.getElementById('install-status').textContent = status;
    }
    
    async function connectToCloud() {
      hideError(1);
      cloudUrl = document.getElementById('cloud-url').value.trim().replace(/\/$/, '');
      
      if (!cloudUrl) {
        showError(1, 'Please enter a cloud URL');
        return;
      }
      
      const btn = document.getElementById('btn-connect');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Connecting...';
      
      try {
        const response = await fetch(`${cloudUrl}/api/health`);
        if (!response.ok) throw new Error('Server not responding');
        showStep(2);
      } catch (err) {
        showError(1, `Cannot connect to ${cloudUrl}. Please check the URL.`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Connect';
      }
    }
    
    async function login() {
      hideError(2);
      const email = document.getElementById('emc-email').value.trim();
      const password = document.getElementById('emc-password').value;
      
      if (!email || !password) {
        showError(2, 'Please enter email and password');
        return;
      }
      
      const btn = document.getElementById('btn-login');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Signing in...';
      
      try {
        const response = await fetch(`${cloudUrl}/api/cal-setup/authenticate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Authentication failed');
        }
        
        sessionToken = data.sessionToken;
        await loadProperties();
        showStep(3);
      } catch (err) {
        showError(2, err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }
    
    async function loadProperties() {
      const response = await fetch(`${cloudUrl}/api/cal-setup/properties`, {
        headers: { 'Authorization': `Bearer ${sessionToken}` }
      });
      
      const data = await response.json();
      const properties = data.properties || [];
      const list = document.getElementById('property-list');
      list.innerHTML = '';
      
      properties.forEach(prop => {
        const item = document.createElement('div');
        item.className = 'device-item';
        item.innerHTML = `
          <div class="icon">üè¢</div>
          <div class="info">
            <h4>${prop.name}</h4>
            <span>${prop.code} ‚Ä¢ ${prop.timezone || 'UTC'}</span>
          </div>
        `;
        item.onclick = () => selectProperty(prop, item);
        list.appendChild(item);
      });
    }
    
    function selectProperty(property, element) {
      document.querySelectorAll('#property-list .device-item').forEach(el => 
        el.classList.remove('selected'));
      element.classList.add('selected');
      selectedProperty = property;
      document.getElementById('btn-select-property').disabled = false;
    }
    
    function getServiceBindingsLabel(bindings) {
      if (!bindings || bindings.length === 0) return 'No services assigned';
      const labels = {
        'caps': 'Order Entry',
        'print_controller': 'Print Controller',
        'kds_controller': 'KDS Controller',
        'payment_controller': 'Payment'
      };
      return bindings.map(b => labels[b] || b).join(', ');
    }

    async function loadDevices() {
      const response = await fetch(`${cloudUrl}/api/cal-setup/devices/${selectedProperty.id}`, {
        headers: { 'Authorization': `Bearer ${sessionToken}` }
      });
      
      const data = await response.json();
      const list = document.getElementById('device-list');
      list.innerHTML = '';
      
      [...(data.workstations || []), ...(data.kdsDevices || [])].forEach(device => {
        const isKds = !device.rvcId;
        const hasPrintController = device.serviceBindings?.includes('print_controller');
        const hasKdsController = device.serviceBindings?.includes('kds_controller');
        const bindingsLabel = getServiceBindingsLabel(device.serviceBindings);
        
        // Setup status badge
        let statusBadge = '';
        if (device.setupStatus === 'completed') {
          statusBadge = '<span style="background:#166534;color:#86efac;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:8px;">SETUP COMPLETE</span>';
        } else if (device.setupStatus === 'in_progress') {
          statusBadge = '<span style="background:#854d0e;color:#fef08a;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:8px;">IN PROGRESS</span>';
        } else if (device.setupStatus === 'failed') {
          statusBadge = '<span style="background:#991b1b;color:#fca5a5;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:8px;">FAILED</span>';
        }
        
        const item = document.createElement('div');
        item.className = 'device-item';
        item.innerHTML = `
          <div class="icon">${isKds ? '&#128250;' : (hasPrintController || hasKdsController ? '&#128424;' : '&#128187;')}</div>
          <div class="info">
            <h4>${device.name}${statusBadge}</h4>
            <span>${isKds ? 'KDS Display' : 'Workstation'}</span>
            ${device.serviceBindings?.length > 0 ? `<div style="margin-top: 4px; font-size: 11px; color: #3b82f6;">${bindingsLabel}</div>` : ''}
          </div>
        `;
        item.onclick = () => selectDevice(device, isKds ? 'kds' : 'workstation', item);
        list.appendChild(item);
      });
    }
    
    function selectDevice(device, type, element) {
      document.querySelectorAll('#device-list .device-item').forEach(el => 
        el.classList.remove('selected'));
      element.classList.add('selected');
      selectedDevice = { ...device, type };
      document.getElementById('btn-select-device').disabled = false;
    }
    
    async function startInstallation() {
      showStep(5);
      document.getElementById('install-log').innerHTML = '';
      document.getElementById('install-buttons').style.display = 'none';
      
      try {
        log('Starting installation...', 'info');
        
        // Report in_progress status
        try {
          await fetch(`${cloudUrl}/api/cal-setup/report-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${sessionToken}`
            },
            body: JSON.stringify({
              workstationId: selectedDevice.id,
              status: 'in_progress',
            })
          });
        } catch (e) { /* ignore - offline or pre-registration */ }
        
        updateProgress(5, 'Creating directories...');
        
        const dirResult = await window.electronAPI.createDirectories(rootDir);
        dirResult.forEach(r => {
          if (r.status === 'created') log(`Created: ${r.path}`, 'success');
          else if (r.status === 'exists') log(`Exists: ${r.path}`, 'info');
          else log(`Error: ${r.path} - ${r.error}`, 'error');
        });
        
        updateProgress(15, 'Registering device...');
        log('Registering device with cloud...', 'info');
        
        const regResponse = await fetch(`${cloudUrl}/api/cal-setup/register-device`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionToken}`
          },
          body: JSON.stringify({
            propertyId: selectedProperty.id,
            deviceId: selectedDevice.id,
            deviceType: selectedDevice.type,
            hostname: systemInfo.hostname,
            ipAddress: getLocalIP(),
          })
        });
        
        if (!regResponse.ok) {
          const err = await regResponse.json();
          throw new Error(err.message || 'Registration failed');
        }
        
        registrationData = await regResponse.json();
        log('Device registered successfully', 'success');
        
        updateProgress(30, 'Downloading Service Host...');
        log('Downloading Service Host executable...', 'info');
        
        const downloadResult = await window.electronAPI.downloadServiceHost(cloudUrl, rootDir);
        if (!downloadResult.success) {
          log(`Download failed: ${downloadResult.error}`, 'warning');
          log('Continuing without Service Host (browser-only mode)', 'warning');
        } else {
          log(`Service Host downloaded (${(downloadResult.size / 1024 / 1024).toFixed(2)} MB)`, 'success');
        }
        
        updateProgress(60, 'Saving configuration...');
        log('Creating configuration file...', 'info');
        
        const configResult = await window.electronAPI.saveConfig(rootDir, {
          cloudUrl: cloudUrl,
          propertyId: selectedProperty.id,
          propertyName: selectedProperty.name,
          deviceId: registrationData.device.id,
          deviceName: registrationData.device.name,
          deviceType: registrationData.device.type,
          deviceToken: registrationData.security.deviceToken,
          registeredDeviceId: registrationData.security.registeredDeviceId,
          rvcId: registrationData.device.rvcId,
        });
        
        if (configResult.success) {
          log(`Configuration saved to ${configResult.path}`, 'success');
        } else {
          throw new Error(`Failed to save config: ${configResult.error}`);
        }
        
        // Provision services based on workstation service bindings
        updateProgress(70, 'Provisioning services...');
        log('Checking workstation service bindings...', 'info');
        
        let provisionedServices = [];
        let printAgentConfig = null;
        let capsConfig = null;
        let paymentControllerConfig = null;
        
        if (selectedDevice.serviceBindings && selectedDevice.serviceBindings.length > 0) {
          log(`Services configured: ${getServiceBindingsLabel(selectedDevice.serviceBindings)}`, 'info');
          
          const provResponse = await fetch(`${cloudUrl}/api/cal-setup/provision-services`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${sessionToken}`
            },
            body: JSON.stringify({
              propertyId: selectedProperty.id,
              workstationId: selectedDevice.id,
              workstationName: selectedDevice.name,
              serviceBindings: selectedDevice.serviceBindings,
            })
          });
          
          if (provResponse.ok) {
            const provData = await provResponse.json();
            provisionedServices = provData.provisioned || [];
            
            for (const svc of provisionedServices) {
              if (svc.service === 'print_controller') {
                // Always set printAgentConfig to download/install locally even if server agent exists
                printAgentConfig = svc.config;
                if (svc.status === 'created') {
                  log(`Print Agent created: ${svc.config.agentName}`, 'success');
                } else {
                  log(`Print Agent exists: ${svc.config.agentName} - will install locally`, 'info');
                }
              } else if (svc.service === 'kds_controller') {
                log('KDS Controller will run in Service Host', 'success');
              } else if (svc.service === 'caps') {
                capsConfig = svc.config;
                if (svc.status === 'created') {
                  log(`Service Host created: ${svc.config.serviceHostName}`, 'success');
                } else {
                  log(`Service Host exists: ${svc.config.serviceHostName} - will configure locally`, 'info');
                }
              } else if (svc.service === 'payment_controller') {
                paymentControllerConfig = svc.config;
                log(`Payment processing enabled (${svc.config.gatewayType})`, 'success');
              }
            }
          } else {
            log('Could not auto-provision services', 'warning');
          }
        } else {
          log('No service bindings configured for this workstation', 'info');
        }

        // If Print Controller is assigned, download and configure Print Agent
        if (printAgentConfig && printAgentConfig.agentToken) {
          updateProgress(75, 'Downloading Print Agent...');
          log('Downloading Print Agent software...', 'info');
          
          const printAgentResult = await window.electronAPI.downloadPrintAgent(cloudUrl, rootDir);
          if (printAgentResult.success) {
            log(`Print Agent downloaded`, 'success');
            
            // Save Print Agent configuration
            const printConfigResult = await window.electronAPI.savePrintAgentConfig(rootDir, {
              server: cloudUrl.replace('https://', 'wss://').replace('http://', 'ws://'),
              token: printAgentConfig.agentToken,
              agentId: printAgentConfig.agentId,
              agentName: printAgentConfig.agentName,
            });
            
            if (printConfigResult.success) {
              log('Print Agent configured with token', 'success');
              
              // Install Print Agent as Windows service and start it
              updateProgress(78, 'Installing Print Agent service...');
              log('Installing Print Agent as Windows service...', 'info');
              const serviceName = `OPH-POS-PrintAgent-${selectedDevice.deviceNumber || 'Default'}`;
              const installResult = await window.electronAPI.installPrintAgentService(rootDir, serviceName);
              if (installResult.success) {
                log(`Print Agent service: ${installResult.message}`, 'success');
              } else {
                log(`Print Agent service install failed: ${installResult.error}`, 'warning');
                // Fallback: start as background process
                log('Starting Print Agent as background process...', 'info');
                const startResult = await window.electronAPI.startPrintAgent(rootDir);
                if (startResult.success) {
                  log(`Print Agent started (PID: ${startResult.pid})`, 'success');
                } else {
                  log(`Print Agent not started: ${startResult.error}`, 'warning');
                  log('You can start it manually later', 'info');
                }
              }
            } else {
              log(`Print Agent config failed: ${printConfigResult.error}`, 'warning');
            }
          } else {
            log(`Print Agent download failed: ${printAgentResult.error}`, 'warning');
          }
        }

        // If CAPS (Service Host) is assigned, save configuration
        if (capsConfig && capsConfig.serviceHostToken) {
          updateProgress(79, 'Configuring Service Host (CAPS)...');
          log('Saving Service Host configuration...', 'info');
          
          const capsConfigResult = await window.electronAPI.saveServiceHostConfig(rootDir, cloudUrl, {
            serviceHostId: capsConfig.serviceHostId,
            serviceHostToken: capsConfig.serviceHostToken,
            propertyId: capsConfig.propertyId,
            services: capsConfig.services,
            port: capsConfig.port,
            dataDir: capsConfig.dataDir,
          });
          
          if (capsConfigResult.success) {
            log('Service Host configuration saved', 'success');
            
            // Try to download Service Host executable (optional)
            updateProgress(81, 'Downloading Service Host executable...');
            log('Downloading Service Host executable...', 'info');
            const exeResult = await window.electronAPI.downloadServiceHostExe(cloudUrl, rootDir);
            if (exeResult.success) {
              log(`Service Host executable downloaded (${(exeResult.size / 1024 / 1024).toFixed(2)} MB)`, 'success');
              
              // Install Service Host as Windows service
              updateProgress(83, 'Installing CAPS service...');
              log('Installing Service Host (CAPS) as Windows service...', 'info');
              const capsServiceName = `OPH-POS-CAPS-${capsConfig.serviceHostId.substring(0, 8)}`;
              const capsInstallResult = await window.electronAPI.installServiceHostService(rootDir, capsServiceName);
              if (capsInstallResult.success) {
                log(`CAPS service: ${capsInstallResult.message}`, 'success');
              } else {
                log(`CAPS service install: ${capsInstallResult.error}`, 'warning');
                log('You can start Service Host manually after setup', 'info');
              }
            } else {
              log('Service Host executable not available (will use Node.js version)', 'info');
              log('CAPS will need to be started manually or via Node.js', 'info');
            }
          } else {
            log(`Service Host config failed: ${capsConfigResult.error}`, 'warning');
          }
        }

        // If Payment Controller is assigned, save configuration
        if (paymentControllerConfig) {
          updateProgress(79, 'Configuring Payment Controller...');
          log('Saving Payment Controller configuration...', 'info');
          
          const paymentConfigResult = await window.electronAPI.savePaymentControllerConfig(rootDir, {
            propertyId: paymentControllerConfig.propertyId,
            gatewayType: paymentControllerConfig.gatewayType,
          });
          
          if (paymentConfigResult.success) {
            log('Payment Controller configuration saved', 'success');
          } else {
            log(`Payment Controller config failed: ${paymentConfigResult.error}`, 'warning');
          }
        }

        // Legacy CAL Client download (optional now)
        updateProgress(80, 'Finalizing setup...');
        const calClientResult = await window.electronAPI.downloadCalClient(cloudUrl, rootDir);
        if (!calClientResult.success) {
          log(`CAL Client not installed (optional)`, 'info');
        } else {
          log(`CAL Client downloaded`, 'success');
          
          const calConfigResult = await window.electronAPI.saveCalClientConfig(rootDir, {
            deviceId: registrationData.security.registeredDeviceId,
            deviceToken: registrationData.security.deviceToken,
            propertyId: selectedProperty.id,
            cloudUrl: cloudUrl,
            serviceHostUrl: null,
          });
          
          if (calConfigResult.success) {
            log(`CAL Client configuration saved`, 'success');
            
            updateProgress(80, 'Installing CAL Client service...');
            log('Installing CAL Client as Windows service...', 'info');
            
            const serviceResult = await window.electronAPI.installCalClientService(rootDir);
            if (serviceResult.success) {
              log(`CAL Client service: ${serviceResult.message}`, 'success');
              calClientInstalled = true;
            } else {
              log(`Could not install CAL Client service: ${serviceResult.error}`, 'warning');
              log('CAL Client can be started manually from command line', 'info');
            }
          } else {
            log(`Failed to save CAL Client config: ${calConfigResult.error}`, 'warning');
          }
        }
        
        updateProgress(85, 'Starting services...');
        
        if (downloadResult.success) {
          log('Starting Service Host...', 'info');
          const startResult = await window.electronAPI.startServiceHost(rootDir);
          if (startResult.success) {
            log(`Service Host started (PID: ${startResult.pid})`, 'success');
          } else {
            log(`Could not start Service Host: ${startResult.error}`, 'warning');
          }
        }
        
        // Report setup status to cloud EMC
        updateProgress(95, 'Reporting setup status...');
        log('Reporting setup status to EMC...', 'info');
        
        const installedServices = [];
        if (printAgentConfig) installedServices.push('print_controller');
        if (selectedDevice.serviceBindings?.includes('kds_controller')) installedServices.push('kds_controller');
        if (selectedDevice.serviceBindings?.includes('caps')) installedServices.push('caps');
        if (selectedDevice.serviceBindings?.includes('payment_controller')) installedServices.push('payment_controller');
        
        try {
          const statusResponse = await fetch(`${cloudUrl}/api/cal-setup/report-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${sessionToken}`
            },
            body: JSON.stringify({
              workstationId: selectedDevice.id,
              status: 'completed',
              installedServices,
              deviceToken: registrationData.security.deviceToken,
              registeredDeviceId: registrationData.security.registeredDeviceId,
            })
          });
          
          if (statusResponse.ok) {
            log('Setup status reported to EMC', 'success');
          } else {
            log('Could not report status (EMC will update on next sync)', 'warning');
          }
        } catch (statusErr) {
          log('Status reporting skipped (offline)', 'info');
        }
        
        updateProgress(100, 'Complete!');
        log('Installation completed successfully!', 'success');
        
        await new Promise(r => setTimeout(r, 1000));
        showComplete();
        
      } catch (err) {
        log(`Error: ${err.message}`, 'error');
        
        // Report failed status
        try {
          await fetch(`${cloudUrl}/api/cal-setup/report-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${sessionToken}`
            },
            body: JSON.stringify({
              workstationId: selectedDevice.id,
              status: 'failed',
            })
          });
        } catch (e) { /* ignore reporting failure */ }
        
        showError(5, err.message);
        document.getElementById('install-buttons').style.display = 'flex';
      }
    }
    
    function getLocalIP() {
      if (!systemInfo.networkInterfaces) return null;
      for (const [name, interfaces] of Object.entries(systemInfo.networkInterfaces)) {
        for (const iface of interfaces) {
          if (iface.family === 'IPv4' && !iface.internal) {
            return iface.address;
          }
        }
      }
      return null;
    }
    
    function showComplete() {
      showStep(6);
      
      const claimCode = registrationData.security.claimCode || 'N/A';
      
      const summary = document.getElementById('summary-card');
      summary.innerHTML = `
        <div style="background: #1a472a; border: 2px solid #22c55e; border-radius: 8px; padding: 16px; margin-bottom: 16px; text-align: center;">
          <div style="color: #86efac; font-size: 12px; margin-bottom: 4px;">CLAIM CODE (enter in browser)</div>
          <div style="color: #22c55e; font-size: 36px; font-family: monospace; font-weight: bold; letter-spacing: 8px;">${claimCode}</div>
          <div style="color: #86efac; font-size: 11px; margin-top: 4px;">Valid for 10 minutes</div>
        </div>
        <div class="row">
          <span class="label">Device Name</span>
          <span class="value">${registrationData.device.name}</span>
        </div>
        <div class="row">
          <span class="label">Type</span>
          <span class="value">${registrationData.device.type === 'kds' ? 'KDS Display' : 'Workstation'}</span>
        </div>
        <div class="row">
          <span class="label">Property</span>
          <span class="value">${registrationData.property.name}</span>
        </div>
        <div class="row">
          <span class="label">Install Directory</span>
          <span class="value">${rootDir}</span>
        </div>
        <div class="row">
          <span class="label">CAL Client</span>
          <span class="value">${calClientInstalled ? 'Installed (auto-updates enabled)' : 'Not installed'}</span>
        </div>
        <div class="row">
          <span class="label">Registered At</span>
          <span class="value">${new Date().toLocaleString()}</span>
        </div>
      `;
    }
    
    async function launchPos() {
      const params = new URLSearchParams({
        device_token: registrationData.security.deviceToken,
        device_id: registrationData.device.id,
        registered_device_id: registrationData.security.registeredDeviceId,
        device_name: registrationData.device.name,
        device_type: registrationData.device.type === 'kds' ? 'kds_display' : 'pos_workstation',
        property_id: registrationData.property.id,
        auto_enroll: 'true'
      });
      const setupUrl = `${cloudUrl}/setup?${params.toString()}`;
      
      await window.electronAPI.writeLog('INFO', 'Launching setup with credentials', {
        setupUrl: setupUrl.replace(registrationData.security.deviceToken, '[REDACTED]'),
        deviceId: registrationData.device.id,
        registeredDeviceId: registrationData.security.registeredDeviceId,
        deviceName: registrationData.device.name,
        deviceType: registrationData.device.type
      });
      
      await window.electronAPI.openPos(setupUrl);
    }
    
    document.getElementById('btn-connect').onclick = connectToCloud;
    document.getElementById('btn-login').onclick = login;
    document.getElementById('btn-back-2').onclick = () => showStep(1);
    document.getElementById('btn-back-3').onclick = () => showStep(2);
    document.getElementById('btn-select-property').onclick = async () => {
      await loadDevices();
      showStep(4);
    };
    document.getElementById('btn-back-4').onclick = () => showStep(3);
    document.getElementById('btn-select-device').onclick = () => startInstallation();
    document.getElementById('btn-retry').onclick = () => startInstallation();
    document.getElementById('btn-launch').onclick = launchPos;
    document.getElementById('btn-exit').onclick = () => window.electronAPI.quitApp();
    
    document.getElementById('cloud-url').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') connectToCloud();
    });
    document.getElementById('emc-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    
    init();
  </script>
</body>
</html>
