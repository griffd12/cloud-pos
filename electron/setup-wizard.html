<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud POS - Terminal Setup</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f1729;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .wizard-container {
      width: 560px;
      max-height: 90vh;
      background: #1e293b;
      border-radius: 12px;
      border: 1px solid #334155;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .wizard-header {
      padding: 24px 32px 16px;
      border-bottom: 1px solid #334155;
      flex-shrink: 0;
    }
    .wizard-header h1 {
      font-size: 20px;
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 4px;
    }
    .wizard-header p {
      font-size: 13px;
      color: #94a3b8;
    }
    .steps-indicator {
      display: flex;
      gap: 8px;
      padding: 16px 32px;
      border-bottom: 1px solid #334155;
      flex-shrink: 0;
    }
    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #475569;
      transition: background 0.3s;
    }
    .step-dot.active { background: #3b82f6; }
    .step-dot.completed { background: #22c55e; }
    .step-label {
      font-size: 12px;
      color: #64748b;
      margin-left: 4px;
      line-height: 8px;
    }
    .step-label.active { color: #93c5fd; }
    .step-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .wizard-body {
      padding: 24px 32px;
      flex: 1;
      overflow-y: auto;
    }
    .step { display: none; }
    .step.active { display: block; }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #cbd5e1;
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      padding: 10px 14px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-group input:focus {
      border-color: #3b82f6;
    }
    .form-group input::placeholder {
      color: #475569;
    }
    .form-hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }
    .selection-list {
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid #334155;
      border-radius: 8px;
      background: #0f172a;
    }
    .selection-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #1e293b;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .selection-item:last-child { border-bottom: none; }
    .selection-item:hover { background: #1e293b; }
    .selection-item.selected {
      background: #1e3a5f;
      border-left: 3px solid #3b82f6;
    }
    .selection-item .item-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: #334155;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      color: #94a3b8;
    }
    .selection-item.selected .item-icon {
      background: #1d4ed8;
      color: #dbeafe;
    }
    .item-details {
      flex: 1;
      min-width: 0;
    }
    .item-name {
      font-size: 14px;
      font-weight: 500;
      color: #f1f5f9;
    }
    .item-meta {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }
    .wizard-footer {
      padding: 16px 32px;
      border-top: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s;
    }
    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    .btn-primary:hover:not(:disabled) { background: #2563eb; }
    .btn-secondary {
      background: #334155;
      color: #e2e8f0;
    }
    .btn-secondary:hover:not(:disabled) { background: #475569; }
    .btn-ghost {
      background: transparent;
      color: #94a3b8;
    }
    .btn-ghost:hover:not(:disabled) { color: #e2e8f0; }
    .status-msg {
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 12px;
      display: none;
    }
    .status-msg.error {
      display: block;
      background: #7f1d1d33;
      color: #fca5a5;
      border: 1px solid #7f1d1d;
    }
    .status-msg.success {
      display: block;
      background: #14532d33;
      color: #86efac;
      border: 1px solid #14532d;
    }
    .status-msg.loading {
      display: block;
      background: #1e3a5f33;
      color: #93c5fd;
      border: 1px solid #1e3a5f;
    }
    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #475569;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    .empty-state p {
      margin-top: 8px;
      font-size: 13px;
    }
    .mode-cards {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }
    .mode-card {
      flex: 1;
      padding: 20px;
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.2s, background 0.2s;
    }
    .mode-card:hover { border-color: #475569; }
    .mode-card.selected {
      border-color: #3b82f6;
      background: #1e3a5f;
    }
    .mode-card .mode-icon {
      font-size: 28px;
      margin-bottom: 8px;
      color: #94a3b8;
    }
    .mode-card.selected .mode-icon { color: #60a5fa; }
    .mode-card .mode-title {
      font-size: 15px;
      font-weight: 600;
      color: #f1f5f9;
    }
    .mode-card .mode-desc {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
    }
    .summary-table td {
      padding: 8px 0;
      font-size: 14px;
      border-bottom: 1px solid #1e293b;
    }
    .summary-table td:first-child {
      color: #94a3b8;
      width: 140px;
    }
    .summary-table td:last-child {
      color: #f1f5f9;
      font-weight: 500;
    }
    .svg-icon {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="wizard-header">
      <h1>Terminal Setup</h1>
      <p>Configure this terminal to connect to your Cloud POS system</p>
    </div>

    <div class="steps-indicator">
      <div class="step-item" id="step-ind-0">
        <div class="step-dot active"></div>
        <span class="step-label active">Server</span>
      </div>
      <div class="step-item" id="step-ind-1">
        <div class="step-dot"></div>
        <span class="step-label">Enterprise</span>
      </div>
      <div class="step-item" id="step-ind-2">
        <div class="step-dot"></div>
        <span class="step-label">Property</span>
      </div>
      <div class="step-item" id="step-ind-3">
        <div class="step-dot"></div>
        <span class="step-label">Device</span>
      </div>
    </div>

    <div class="wizard-body">
      <!-- Step 0: Server URL -->
      <div class="step active" id="step-0">
        <div class="form-group">
          <label>Cloud Server URL</label>
          <input type="url" id="server-url" placeholder="https://yourpos.example.com" autocomplete="off" spellcheck="false" />
          <div class="form-hint">Enter the URL of your Cloud POS server</div>
        </div>
        <button class="btn btn-primary" id="btn-test-connection" onclick="testConnection()">Test Connection</button>
        <div class="status-msg" id="connection-status"></div>
      </div>

      <!-- Step 1: Enterprise Selection -->
      <div class="step" id="step-1">
        <div class="form-group">
          <label>Select Enterprise</label>
        </div>
        <div id="enterprise-list" class="selection-list"></div>
        <div class="status-msg" id="enterprise-status"></div>
      </div>

      <!-- Step 2: Property Selection -->
      <div class="step" id="step-2">
        <div class="form-group">
          <label>Select Property</label>
          <div class="form-hint" id="property-hint"></div>
        </div>
        <div id="property-list" class="selection-list"></div>
        <div class="status-msg" id="property-status"></div>
      </div>

      <!-- Step 3: Mode + Device Selection -->
      <div class="step" id="step-3">
        <div class="form-group">
          <label>Terminal Mode</label>
        </div>
        <div class="mode-cards">
          <div class="mode-card selected" id="mode-pos" onclick="selectMode('pos')">
            <div class="mode-icon">
              <svg class="svg-icon" style="width:28px;height:28px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            </div>
            <div class="mode-title">POS Workstation</div>
            <div class="mode-desc">Point of Sale terminal</div>
          </div>
          <div class="mode-card" id="mode-kds" onclick="selectMode('kds')">
            <div class="mode-icon">
              <svg class="svg-icon" style="width:28px;height:28px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M6 10h4"/><path d="M14 10h4"/><path d="M6 14h4"/><path d="M14 14h4"/></svg>
            </div>
            <div class="mode-title">Kitchen Display</div>
            <div class="mode-desc">KDS order screen</div>
          </div>
        </div>
        <div class="form-group">
          <label id="device-list-label">Select Workstation</label>
        </div>
        <div id="device-list" class="selection-list"></div>
        <div class="status-msg" id="device-status"></div>
      </div>

      <!-- Step 4: Summary / Confirm -->
      <div class="step" id="step-4">
        <div class="form-group">
          <label>Configuration Summary</label>
          <div class="form-hint">Review your terminal settings before saving</div>
        </div>
        <table class="summary-table" id="summary-table">
          <tr><td>Server</td><td id="sum-server"></td></tr>
          <tr><td>Enterprise</td><td id="sum-enterprise"></td></tr>
          <tr><td>Property</td><td id="sum-property"></td></tr>
          <tr><td>Mode</td><td id="sum-mode"></td></tr>
          <tr><td>Device</td><td id="sum-device"></td></tr>
          <tr><td>RVC</td><td id="sum-rvc"></td></tr>
        </table>
        <div class="status-msg" id="save-status"></div>
      </div>
    </div>

    <div class="wizard-footer">
      <button class="btn btn-ghost" id="btn-back" onclick="goBack()" style="visibility:hidden">Back</button>
      <button class="btn btn-primary" id="btn-next" onclick="goNext()" disabled>Next</button>
    </div>
  </div>

  <script>
    let currentStep = 0;
    const totalSteps = 5;

    let state = {
      serverUrl: '',
      connectionVerified: false,
      enterprises: [],
      selectedEnterprise: null,
      properties: [],
      selectedProperty: null,
      rvcs: [],
      mode: 'pos',
      devices: [],
      selectedDevice: null,
      selectedRvc: null,
    };

    function updateStepIndicators() {
      for (let i = 0; i < 4; i++) {
        const ind = document.getElementById(`step-ind-${i}`);
        const dot = ind.querySelector('.step-dot');
        const label = ind.querySelector('.step-label');
        dot.className = 'step-dot';
        label.className = 'step-label';
        if (i < currentStep) {
          dot.classList.add('completed');
        } else if (i === currentStep || (currentStep === 4 && i === 3)) {
          dot.classList.add('active');
          label.classList.add('active');
        }
      }
    }

    function showStep(n) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step-${n}`).classList.add('active');
      currentStep = n;
      updateStepIndicators();

      document.getElementById('btn-back').style.visibility = n > 0 ? 'visible' : 'hidden';

      if (n === 4) {
        document.getElementById('btn-next').textContent = 'Save & Launch';
        document.getElementById('btn-next').disabled = false;
      } else {
        document.getElementById('btn-next').textContent = 'Next';
      }
      updateNextButton();
    }

    function updateNextButton() {
      const btn = document.getElementById('btn-next');
      if (currentStep === 4) {
        btn.disabled = false;
        return;
      }
      switch (currentStep) {
        case 0:
          btn.disabled = !state.connectionVerified;
          break;
        case 1:
          btn.disabled = !state.selectedEnterprise;
          break;
        case 2:
          btn.disabled = !state.selectedProperty;
          break;
        case 3:
          btn.disabled = !state.selectedDevice;
          break;
      }
    }

    async function testConnection() {
      const urlInput = document.getElementById('server-url');
      const statusEl = document.getElementById('connection-status');
      const btn = document.getElementById('btn-test-connection');
      let url = urlInput.value.trim().replace(/\/+$/, '');

      if (!url) {
        statusEl.className = 'status-msg error';
        statusEl.textContent = 'Please enter a server URL';
        return;
      }

      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
        urlInput.value = url;
      }

      btn.disabled = true;
      statusEl.className = 'status-msg loading';
      statusEl.innerHTML = '<span class="loading-spinner"></span>Testing connection...';

      try {
        const result = await window.wizardAPI.testConnection(url);
        if (result.success) {
          statusEl.className = 'status-msg success';
          statusEl.textContent = 'Connected successfully';
          state.serverUrl = url;
          state.connectionVerified = true;
          updateNextButton();
        } else {
          statusEl.className = 'status-msg error';
          statusEl.textContent = result.error || 'Connection failed. Check the URL and try again.';
          state.connectionVerified = false;
          updateNextButton();
        }
      } catch (e) {
        statusEl.className = 'status-msg error';
        statusEl.textContent = 'Connection failed: ' + e.message;
        state.connectionVerified = false;
        updateNextButton();
      }
      btn.disabled = false;
    }

    async function loadEnterprises() {
      const listEl = document.getElementById('enterprise-list');
      const statusEl = document.getElementById('enterprise-status');
      listEl.innerHTML = '<div class="empty-state"><span class="loading-spinner"></span><p>Loading enterprises...</p></div>';
      statusEl.className = 'status-msg';

      try {
        const result = await window.wizardAPI.fetchEnterprises(state.serverUrl);
        if (!result.success) throw new Error(result.error);

        state.enterprises = result.data;
        if (state.enterprises.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><p>No enterprises found on this server.</p></div>';
          return;
        }

        listEl.innerHTML = state.enterprises.map(e => `
          <div class="selection-item" data-id="${e.id}" onclick="selectEnterprise('${e.id}')">
            <div class="item-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M3 10h18M3 7l9-4 9 4M4 10v11M20 10v11M8 14v3M12 14v3M16 14v3"/></svg>
            </div>
            <div class="item-details">
              <div class="item-name">${escHtml(e.name)}</div>
              <div class="item-meta">${escHtml(e.code || '')}</div>
            </div>
          </div>
        `).join('');

        if (state.enterprises.length === 1) {
          selectEnterprise(state.enterprises[0].id);
        }
      } catch (e) {
        statusEl.className = 'status-msg error';
        statusEl.textContent = 'Failed to load enterprises: ' + e.message;
        listEl.innerHTML = '';
      }
    }

    function selectEnterprise(id) {
      state.selectedEnterprise = state.enterprises.find(e => String(e.id) === String(id));
      document.querySelectorAll('#enterprise-list .selection-item').forEach(el => {
        el.classList.toggle('selected', el.dataset.id === String(id));
      });
      state.selectedProperty = null;
      state.selectedDevice = null;
      updateNextButton();
    }

    async function loadProperties() {
      const listEl = document.getElementById('property-list');
      const statusEl = document.getElementById('property-status');
      const hintEl = document.getElementById('property-hint');
      hintEl.textContent = `Properties for ${state.selectedEnterprise.name}`;
      listEl.innerHTML = '<div class="empty-state"><span class="loading-spinner"></span><p>Loading properties...</p></div>';
      statusEl.className = 'status-msg';

      try {
        const result = await window.wizardAPI.fetchProperties(state.serverUrl, state.selectedEnterprise.id);
        if (!result.success) throw new Error(result.error);

        state.properties = result.data;
        if (state.properties.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><p>No properties configured for this enterprise.</p></div>';
          return;
        }

        listEl.innerHTML = state.properties.map(p => `
          <div class="selection-item" data-id="${p.id}" onclick="selectProperty('${p.id}')">
            <div class="item-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </div>
            <div class="item-details">
              <div class="item-name">${escHtml(p.name)}</div>
              <div class="item-meta">${escHtml(p.address || p.city || '')}</div>
            </div>
          </div>
        `).join('');

        if (state.properties.length === 1) {
          selectProperty(state.properties[0].id);
        }
      } catch (e) {
        statusEl.className = 'status-msg error';
        statusEl.textContent = 'Failed to load properties: ' + e.message;
        listEl.innerHTML = '';
      }
    }

    function selectProperty(id) {
      state.selectedProperty = state.properties.find(p => String(p.id) === String(id));
      document.querySelectorAll('#property-list .selection-item').forEach(el => {
        el.classList.toggle('selected', el.dataset.id === String(id));
      });
      state.selectedDevice = null;
      updateNextButton();
    }

    function selectMode(mode) {
      state.mode = mode;
      document.getElementById('mode-pos').classList.toggle('selected', mode === 'pos');
      document.getElementById('mode-kds').classList.toggle('selected', mode === 'kds');
      document.getElementById('device-list-label').textContent = mode === 'pos' ? 'Select Workstation' : 'Select KDS Device';
      state.selectedDevice = null;
      loadDevices();
    }

    async function loadDevices() {
      const listEl = document.getElementById('device-list');
      const statusEl = document.getElementById('device-status');
      listEl.innerHTML = '<div class="empty-state"><span class="loading-spinner"></span><p>Loading devices...</p></div>';
      statusEl.className = 'status-msg';

      try {
        const result = await window.wizardAPI.fetchDevices(
          state.serverUrl,
          state.selectedEnterprise.id,
          state.selectedProperty.id,
          state.mode
        );
        if (!result.success) throw new Error(result.error);

        state.devices = result.data;
        const rvcResult = await window.wizardAPI.fetchRvcs(state.serverUrl, state.selectedProperty.id);
        if (rvcResult.success) {
          state.rvcs = rvcResult.data;
        }

        if (state.devices.length === 0) {
          const type = state.mode === 'pos' ? 'workstations' : 'KDS devices';
          listEl.innerHTML = `<div class="empty-state"><p>No ${type} configured for this property. Create one in EMC first.</p></div>`;
          return;
        }

        listEl.innerHTML = state.devices.map(d => {
          const rvc = state.rvcs.find(r => String(r.id) === String(d.rvcId));
          const rvcName = rvc ? rvc.name : '';
          const icon = state.mode === 'pos'
            ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>'
            : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M6 10h4"/><path d="M14 10h4"/></svg>';
          return `
            <div class="selection-item" data-id="${d.id}" data-rvc="${d.rvcId || ''}" onclick="selectDevice('${d.id}')">
              <div class="item-icon">${icon}</div>
              <div class="item-details">
                <div class="item-name">${escHtml(d.name)}</div>
                <div class="item-meta">${rvcName ? 'RVC: ' + escHtml(rvcName) : 'No RVC assigned'}${d.ipAddress ? ' | IP: ' + escHtml(d.ipAddress) : ''}</div>
              </div>
            </div>
          `;
        }).join('');

        if (state.devices.length === 1) {
          selectDevice(state.devices[0].id);
        }
      } catch (e) {
        statusEl.className = 'status-msg error';
        statusEl.textContent = 'Failed to load devices: ' + e.message;
        listEl.innerHTML = '';
      }
    }

    function selectDevice(id) {
      state.selectedDevice = state.devices.find(d => String(d.id) === String(id));
      if (state.selectedDevice && state.selectedDevice.rvcId) {
        state.selectedRvc = state.rvcs.find(r => String(r.id) === String(state.selectedDevice.rvcId));
      } else {
        state.selectedRvc = state.rvcs.length > 0 ? state.rvcs[0] : null;
      }
      document.querySelectorAll('#device-list .selection-item').forEach(el => {
        el.classList.toggle('selected', el.dataset.id === String(id));
      });
      updateNextButton();
    }

    function buildSummary() {
      document.getElementById('sum-server').textContent = state.serverUrl;
      document.getElementById('sum-enterprise').textContent = state.selectedEnterprise?.name || '-';
      document.getElementById('sum-property').textContent = state.selectedProperty?.name || '-';
      document.getElementById('sum-mode').textContent = state.mode === 'pos' ? 'POS Workstation' : 'Kitchen Display (KDS)';
      document.getElementById('sum-device').textContent = state.selectedDevice?.name || '-';
      document.getElementById('sum-rvc').textContent = state.selectedRvc?.name || 'Default';
    }

    async function goNext() {
      if (currentStep === 0 && state.connectionVerified) {
        showStep(1);
        loadEnterprises();
      } else if (currentStep === 1 && state.selectedEnterprise) {
        showStep(2);
        loadProperties();
      } else if (currentStep === 2 && state.selectedProperty) {
        showStep(3);
        loadDevices();
      } else if (currentStep === 3 && state.selectedDevice) {
        buildSummary();
        showStep(4);
      } else if (currentStep === 4) {
        await saveAndLaunch();
      }
    }

    function goBack() {
      if (currentStep > 0) {
        showStep(currentStep - 1);
      }
    }

    async function saveAndLaunch() {
      const statusEl = document.getElementById('save-status');
      const btn = document.getElementById('btn-next');
      btn.disabled = true;
      statusEl.className = 'status-msg loading';
      statusEl.innerHTML = '<span class="loading-spinner"></span>Saving configuration and launching...';

      try {
        const config = {
          serverUrl: state.serverUrl,
          enterpriseId: state.selectedEnterprise.id,
          enterpriseName: state.selectedEnterprise.name,
          enterpriseCode: state.selectedEnterprise.code,
          propertyId: state.selectedProperty.id,
          propertyName: state.selectedProperty.name,
          rvcId: state.selectedRvc?.id || null,
          rvcName: state.selectedRvc?.name || null,
          mode: state.mode,
          deviceId: state.selectedDevice.id,
          deviceName: state.selectedDevice.name,
          deviceType: state.mode === 'pos' ? 'workstation' : 'kds',
          setupComplete: true,
          setupDate: new Date().toISOString(),
        };

        const result = await window.wizardAPI.saveConfig(config);
        if (result.success) {
          statusEl.className = 'status-msg success';
          statusEl.textContent = 'Configuration saved. Launching POS...';
          setTimeout(() => {
            window.wizardAPI.launchApp();
          }, 1000);
        } else {
          throw new Error(result.error || 'Failed to save');
        }
      } catch (e) {
        statusEl.className = 'status-msg error';
        statusEl.textContent = 'Save failed: ' + e.message;
        btn.disabled = false;
      }
    }

    function escHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    document.getElementById('server-url').addEventListener('input', () => {
      state.connectionVerified = false;
      updateNextButton();
    });

    document.getElementById('server-url').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') testConnection();
    });

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const existing = await window.wizardAPI.getExistingConfig();
        if (existing && existing.serverUrl) {
          document.getElementById('server-url').value = existing.serverUrl;
        }
      } catch (e) {}
    });
  </script>
</body>
</html>
