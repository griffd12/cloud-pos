<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OPS-POS Setup Wizard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .wizard-container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 600px;
      overflow: hidden;
    }
    
    .wizard-header {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      padding: 24px 32px;
      text-align: center;
    }
    
    .wizard-header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .wizard-header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .progress-bar {
      display: flex;
      justify-content: space-between;
      padding: 20px 32px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .step-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #64748b;
    }
    
    .step-indicator.active {
      color: #2563eb;
      font-weight: 600;
    }
    
    .step-indicator.completed {
      color: #16a34a;
    }
    
    .step-circle {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
    }
    
    .step-indicator.active .step-circle {
      background: #2563eb;
      color: white;
    }
    
    .step-indicator.completed .step-circle {
      background: #16a34a;
      color: white;
    }
    
    .wizard-content {
      padding: 32px;
      min-height: 300px;
    }
    
    .step {
      display: none;
    }
    
    .step.active {
      display: block;
    }
    
    .step h2 {
      font-size: 20px;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .step p {
      color: #64748b;
      margin-bottom: 24px;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-group input::placeholder {
      color: #9ca3af;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      padding: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .radio-option:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }
    
    .radio-option.selected {
      background: #eff6ff;
      border-color: #2563eb;
    }
    
    .radio-option input {
      margin-right: 12px;
    }
    
    .radio-option .option-content {
      flex: 1;
    }
    
    .radio-option .option-name {
      font-weight: 500;
      color: #1e293b;
    }
    
    .radio-option .option-details {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }
    
    .radio-option .option-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      background: #e2e8f0;
      color: #475569;
    }
    
    .radio-option .option-badge.workstation {
      background: #dbeafe;
      color: #1d4ed8;
    }
    
    .radio-option .option-badge.kds {
      background: #fef3c7;
      color: #b45309;
    }
    
    .wizard-footer {
      padding: 20px 32px;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1d4ed8;
    }
    
    .btn-primary:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #475569;
    }
    
    .btn-secondary:hover {
      background: #cbd5e1;
    }
    
    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .success-message {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .install-progress {
      margin-top: 24px;
    }
    
    .progress-track {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .install-log {
      margin-top: 16px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      background: #1e293b;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .install-log .log-line {
      margin-bottom: 4px;
    }
    
    .install-log .log-line.success {
      color: #4ade80;
    }
    
    .install-log .log-line.error {
      color: #f87171;
    }
    
    .install-log .log-line.info {
      color: #60a5fa;
    }
    
    .complete-icon {
      width: 80px;
      height: 80px;
      background: #16a34a;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }
    
    .complete-icon svg {
      width: 40px;
      height: 40px;
      color: white;
    }
    
    .device-summary {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .device-summary .row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .device-summary .row:last-child {
      border-bottom: none;
    }
    
    .device-summary .label {
      color: #64748b;
      font-size: 14px;
    }
    
    .device-summary .value {
      color: #1e293b;
      font-weight: 500;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="wizard-header">
      <h1>OPS-POS Setup Wizard</h1>
      <p>Configure this device for Point of Sale operations</p>
    </div>
    
    <div class="progress-bar">
      <div class="step-indicator active" id="indicator-1">
        <div class="step-circle">1</div>
        <span>Connect</span>
      </div>
      <div class="step-indicator" id="indicator-2">
        <div class="step-circle">2</div>
        <span>Login</span>
      </div>
      <div class="step-indicator" id="indicator-3">
        <div class="step-circle">3</div>
        <span>Property</span>
      </div>
      <div class="step-indicator" id="indicator-4">
        <div class="step-circle">4</div>
        <span>Device</span>
      </div>
      <div class="step-indicator" id="indicator-5">
        <div class="step-circle">5</div>
        <span>Install</span>
      </div>
    </div>
    
    <div class="wizard-content">
      <!-- Step 1: Cloud URL -->
      <div class="step active" id="step-1">
        <h2>Connect to Cloud</h2>
        <p>Enter the URL for your OPS-POS cloud environment.</p>
        
        <div id="step1-error" class="error-message" style="display: none;"></div>
        
        <div class="form-group">
          <label for="cloudUrl">Cloud URL</label>
          <input type="url" id="cloudUrl" placeholder="https://pos.yourcompany.com" />
        </div>
      </div>
      
      <!-- Step 2: Login -->
      <div class="step" id="step-2">
        <h2>EMC Login</h2>
        <p>Enter your Enterprise Management Console credentials.</p>
        
        <div id="step2-error" class="error-message" style="display: none;"></div>
        
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="admin@example.com" />
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter your password" />
        </div>
      </div>
      
      <!-- Step 3: Select Property -->
      <div class="step" id="step-3">
        <h2>Select Property</h2>
        <p>Choose the property this device will be assigned to.</p>
        
        <div id="step3-error" class="error-message" style="display: none;"></div>
        
        <div class="radio-group" id="properties-list">
          <!-- Properties will be populated here -->
        </div>
      </div>
      
      <!-- Step 4: Select Device -->
      <div class="step" id="step-4">
        <h2>Select Device</h2>
        <p>Choose which workstation or KDS this device will be configured as.</p>
        
        <div id="step4-error" class="error-message" style="display: none;"></div>
        
        <div class="radio-group" id="devices-list">
          <!-- Devices will be populated here -->
        </div>
      </div>
      
      <!-- Step 5: Installing -->
      <div class="step" id="step-5">
        <h2>Installing...</h2>
        <p>Please wait while we configure this device.</p>
        
        <div class="install-progress">
          <div class="progress-track">
            <div class="progress-fill" id="install-progress" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="install-log" id="install-log">
          <!-- Install log will appear here -->
        </div>
      </div>
      
      <!-- Step 6: Complete -->
      <div class="step" id="step-6">
        <div class="complete-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        
        <h2 style="text-align: center;">Setup Complete!</h2>
        <p style="text-align: center;">This device is now configured and ready for use.</p>
        
        <div class="device-summary" id="device-summary">
          <!-- Summary will be populated here -->
        </div>
      </div>
    </div>
    
    <div class="wizard-footer">
      <button class="btn btn-secondary" id="btn-back" disabled>Back</button>
      <button class="btn btn-primary" id="btn-next">Connect</button>
    </div>
  </div>
  
  <script>
    // Wizard State
    let currentStep = 1;
    let sessionToken = null;
    let cloudUrl = '';
    let user = null;
    let properties = [];
    let devices = { workstations: [], kdsDevices: [] };
    let selectedProperty = null;
    let selectedDevice = null;
    let selectedDeviceType = null;
    
    // DOM Elements
    const steps = document.querySelectorAll('.step');
    const indicators = document.querySelectorAll('.step-indicator');
    const btnBack = document.getElementById('btn-back');
    const btnNext = document.getElementById('btn-next');
    
    // Initialize
    updateButtons();
    
    // Event Listeners
    btnBack.addEventListener('click', goBack);
    btnNext.addEventListener('click', goNext);
    
    document.getElementById('cloudUrl').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') goNext();
    });
    
    document.getElementById('password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') goNext();
    });
    
    function updateButtons() {
      btnBack.disabled = currentStep === 1 || currentStep === 5 || currentStep === 6;
      
      switch (currentStep) {
        case 1:
          btnNext.textContent = 'Connect';
          btnNext.disabled = false;
          break;
        case 2:
          btnNext.textContent = 'Login';
          btnNext.disabled = false;
          break;
        case 3:
          btnNext.textContent = 'Next';
          btnNext.disabled = !selectedProperty;
          break;
        case 4:
          btnNext.textContent = 'Install';
          btnNext.disabled = !selectedDevice;
          break;
        case 5:
          btnNext.textContent = 'Installing...';
          btnNext.disabled = true;
          break;
        case 6:
          btnNext.textContent = 'Restart Device';
          btnNext.disabled = false;
          break;
      }
    }
    
    function showStep(step) {
      steps.forEach((s, i) => {
        s.classList.toggle('active', i + 1 === step);
      });
      
      indicators.forEach((ind, i) => {
        ind.classList.remove('active', 'completed');
        if (i + 1 === step) {
          ind.classList.add('active');
        } else if (i + 1 < step) {
          ind.classList.add('completed');
          ind.querySelector('.step-circle').innerHTML = '&#10003;';
        }
      });
      
      currentStep = step;
      updateButtons();
    }
    
    function showError(step, message) {
      const errorEl = document.getElementById(`step${step}-error`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }
    
    function hideError(step) {
      const errorEl = document.getElementById(`step${step}-error`);
      if (errorEl) {
        errorEl.style.display = 'none';
      }
    }
    
    async function goNext() {
      hideError(currentStep);
      
      switch (currentStep) {
        case 1:
          await connectToCloud();
          break;
        case 2:
          await login();
          break;
        case 3:
          if (selectedProperty) {
            await loadDevices();
          }
          break;
        case 4:
          if (selectedDevice) {
            await startInstallation();
          }
          break;
        case 6:
          // Restart device or close wizard
          window.close();
          break;
      }
    }
    
    function goBack() {
      if (currentStep > 1 && currentStep < 5) {
        showStep(currentStep - 1);
      }
    }
    
    async function connectToCloud() {
      cloudUrl = document.getElementById('cloudUrl').value.trim();
      
      if (!cloudUrl) {
        showError(1, 'Please enter the cloud URL');
        return;
      }
      
      // Ensure URL doesn't end with /
      cloudUrl = cloudUrl.replace(/\/$/, '');
      
      // Validate URL format
      try {
        new URL(cloudUrl);
      } catch {
        showError(1, 'Please enter a valid URL');
        return;
      }
      
      btnNext.disabled = true;
      btnNext.innerHTML = '<span class="loading-spinner"></span>Connecting...';
      
      try {
        // Test connectivity by calling a simple endpoint
        const response = await fetch(`${cloudUrl}/api/health`, { 
          method: 'GET',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error('Unable to connect to cloud server');
        }
        
        showStep(2);
      } catch (error) {
        showError(1, 'Unable to connect to cloud server. Please check the URL.');
      } finally {
        btnNext.disabled = false;
        updateButtons();
      }
    }
    
    async function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        showError(2, 'Please enter your email and password');
        return;
      }
      
      btnNext.disabled = true;
      btnNext.innerHTML = '<span class="loading-spinner"></span>Logging in...';
      
      try {
        const response = await fetch(`${cloudUrl}/api/cal-setup/authenticate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Login failed');
        }
        
        sessionToken = data.sessionToken;
        user = data.user;
        
        await loadProperties();
      } catch (error) {
        showError(2, error.message || 'Login failed. Please check your credentials.');
      } finally {
        btnNext.disabled = false;
        updateButtons();
      }
    }
    
    async function loadProperties() {
      try {
        const response = await fetch(`${cloudUrl}/api/cal-setup/properties`, {
          headers: { 'Authorization': `Bearer ${sessionToken}` }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to load properties');
        }
        
        properties = data.properties;
        
        if (properties.length === 0) {
          showError(2, 'No properties found. Please contact your administrator.');
          return;
        }
        
        // If only one property, auto-select and skip
        if (properties.length === 1) {
          selectedProperty = properties[0];
          await loadDevices();
          return;
        }
        
        renderProperties();
        showStep(3);
      } catch (error) {
        showError(2, error.message || 'Failed to load properties');
      }
    }
    
    function renderProperties() {
      const container = document.getElementById('properties-list');
      container.innerHTML = properties.map(prop => `
        <label class="radio-option ${selectedProperty?.id === prop.id ? 'selected' : ''}" data-id="${prop.id}">
          <input type="radio" name="property" value="${prop.id}" ${selectedProperty?.id === prop.id ? 'checked' : ''} />
          <div class="option-content">
            <div class="option-name">${prop.name}</div>
            <div class="option-details">${prop.address || prop.code || ''}</div>
          </div>
        </label>
      `).join('');
      
      container.querySelectorAll('.radio-option').forEach(option => {
        option.addEventListener('click', () => {
          container.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          const propId = option.dataset.id;
          selectedProperty = properties.find(p => p.id === propId);
          updateButtons();
        });
      });
    }
    
    async function loadDevices() {
      btnNext.disabled = true;
      btnNext.innerHTML = '<span class="loading-spinner"></span>Loading devices...';
      
      try {
        const response = await fetch(`${cloudUrl}/api/cal-setup/devices/${selectedProperty.id}`, {
          headers: { 'Authorization': `Bearer ${sessionToken}` }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Failed to load devices');
        }
        
        devices = data;
        renderDevices();
        showStep(4);
      } catch (error) {
        showError(3, error.message || 'Failed to load devices');
      } finally {
        btnNext.disabled = false;
        updateButtons();
      }
    }
    
    function renderDevices() {
      const container = document.getElementById('devices-list');
      
      const allDevices = [
        ...devices.workstations.map(d => ({ ...d, deviceType: 'workstation' })),
        ...devices.kdsDevices.map(d => ({ ...d, deviceType: 'kds' }))
      ];
      
      if (allDevices.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #64748b;">No devices configured for this property. Please add devices in EMC first.</p>';
        return;
      }
      
      container.innerHTML = allDevices.map(device => `
        <label class="radio-option ${selectedDevice?.id === device.id ? 'selected' : ''}" data-id="${device.id}" data-type="${device.deviceType}">
          <input type="radio" name="device" value="${device.id}" ${selectedDevice?.id === device.id ? 'checked' : ''} />
          <div class="option-content">
            <div class="option-name">${device.name}</div>
            <div class="option-details">${device.deviceType === 'kds' ? device.stationType || 'KDS' : `WS #${device.number || 'â€”'}`}</div>
          </div>
          <span class="option-badge ${device.deviceType}">${device.deviceType === 'kds' ? 'KDS' : 'Workstation'}</span>
        </label>
      `).join('');
      
      container.querySelectorAll('.radio-option').forEach(option => {
        option.addEventListener('click', () => {
          container.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          const deviceId = option.dataset.id;
          const deviceType = option.dataset.type;
          selectedDeviceType = deviceType;
          selectedDevice = deviceType === 'kds' 
            ? devices.kdsDevices.find(d => d.id === deviceId)
            : devices.workstations.find(d => d.id === deviceId);
          updateButtons();
        });
      });
    }
    
    async function startInstallation() {
      showStep(5);
      
      const progressEl = document.getElementById('install-progress');
      const logEl = document.getElementById('install-log');
      
      function log(message, type = '') {
        const line = document.createElement('div');
        line.className = `log-line ${type}`;
        line.textContent = message;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }
      
      function setProgress(percent) {
        progressEl.style.width = `${percent}%`;
      }
      
      try {
        // Step 1: Register device
        log('Registering device with cloud...', 'info');
        setProgress(10);
        
        const registerResponse = await fetch(`${cloudUrl}/api/cal-setup/register-device`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${sessionToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            propertyId: selectedProperty.id,
            deviceId: selectedDevice.id,
            deviceType: selectedDeviceType,
            hostname: window.location.hostname,
          })
        });
        
        const registration = await registerResponse.json();
        
        if (!registerResponse.ok) {
          throw new Error(registration.message || 'Registration failed');
        }
        
        log('Device registered successfully', 'success');
        setProgress(30);
        
        // Step 2: Download configuration
        log('Downloading configuration...', 'info');
        await new Promise(r => setTimeout(r, 500));
        setProgress(50);
        log('Configuration downloaded', 'success');
        
        // Step 3: Create directories
        log('Creating directory structure...', 'info');
        await new Promise(r => setTimeout(r, 500));
        setProgress(60);
        log(`Root directory: ${registration.installation.rootDir}`, 'info');
        log('Directories created', 'success');
        
        // Step 4: Download Service Host (simulated for browser)
        log('Downloading Service Host...', 'info');
        await new Promise(r => setTimeout(r, 1000));
        setProgress(80);
        log('Service Host downloaded', 'success');
        
        // Step 5: Start services
        log('Starting services...', 'info');
        await new Promise(r => setTimeout(r, 500));
        setProgress(90);
        log('Service Host started', 'success');
        
        // Step 6: Final verification
        log('Verifying installation...', 'info');
        await new Promise(r => setTimeout(r, 500));
        setProgress(100);
        log('Installation complete!', 'success');
        
        // Show completion
        await new Promise(r => setTimeout(r, 1000));
        showComplete(registration);
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        btnNext.disabled = false;
        btnNext.textContent = 'Retry';
      }
    }
    
    function showComplete(registration) {
      showStep(6);
      
      const summary = document.getElementById('device-summary');
      summary.innerHTML = `
        <div class="row">
          <span class="label">Device Name</span>
          <span class="value">${registration.device.name}</span>
        </div>
        <div class="row">
          <span class="label">Type</span>
          <span class="value">${registration.device.type === 'kds' ? 'KDS Display' : 'Workstation'}</span>
        </div>
        <div class="row">
          <span class="label">Property</span>
          <span class="value">${registration.property.name}</span>
        </div>
        ${registration.rvc ? `
        <div class="row">
          <span class="label">Revenue Center</span>
          <span class="value">${registration.rvc.name}</span>
        </div>
        ` : ''}
        <div class="row">
          <span class="label">Registered By</span>
          <span class="value">${registration.registeredBy}</span>
        </div>
        <div class="row">
          <span class="label">Registered At</span>
          <span class="value">${new Date(registration.registeredAt).toLocaleString()}</span>
        </div>
      `;
    }
  </script>
</body>
</html>
